name: PR Checks

# Default settings
defaults:
  run:
    shell: bash

permissions:
  contents: read

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

# Global environment variables
env:
  HEDERA_NETWORK: "localhost"

jobs:
  setup:
    name: Setup Environment
    runs-on: hiero-client-sdk-linux-medium
    outputs:
      go-path: ${{ steps.go.outputs.go-path }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2.10.4
        with:
          egress-policy: audit

      - name: Setup GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends gcc libc6-dev libc-dev

      - name: Setup NodeJS
        uses: actions/setup-node@v4.2.0
        with:
          node-version: 18

      - name: Set up Go 1.20
        id: go
        uses: actions/setup-go@v5.3.0
        with:
          go-version: "1.20"

      - name: Check out code
        uses: actions/checkout@v4.2.2

  build:
    name: Build SDK and Examples
    needs: setup
    runs-on: hiero-client-sdk-linux-medium
    steps:
      - name: Vet SDK and Examples
        run: go vet ./...

      - name: Build SDK and Examples
        run: go build -v ./...

      - name: Lint
        uses: golangci/golangci-lint-action@v6.2.0
        with:
          skip-cache: true
          args: --timeout=5m

  test:
    name: Unit and Integration Tests
    needs: build
    runs-on: hiero-client-sdk-linux-medium
    strategy:
      matrix:
        test-type: [unit, e2e]
    steps:
      - name: Start local node (E2E only)
        if: matrix.test-type == 'e2e'
        run: npx @hashgraph/hedera-local start -d --network local --network-tag=0.57.0 --balance=100000

      - name: Run Tests
        run: |
          if [ "${{ matrix.test-type }}" == "unit" ]; then
            go test ./sdk -tags="unit" -timeout 600s -v -coverprofile=unit.out -covermode=atomic -race
          else
            go test ./sdk -tags="e2e" -timeout 1800s -v -coverprofile=e2e.out -covermode=atomic -race
          fi

      - name: Upload Test Coverage to Codecov
        if: success()
        uses: codecov/codecov-action@v5.0.7
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ${{ matrix.test-type }}.out

      - name: Stop local node (E2E only)
        if: matrix.test-type == 'e2e'
        run: npx @hashgraph/hedera-local stop

  run-examples:
    name: Run Examples
    needs: build
    runs-on: hiero-client-sdk-linux-medium
    env:
      OPERATOR_KEY: "302e020100300506032b65700422042091132178e72057a1d7528025956fe39b0b847f200ab59b2fdd367017f3087137"
      OPERATOR_ID: "0.0.2"
    steps:
      - name: Install Task
        run: go install github.com/go-task/task/v3/cmd/task@v3.17.0

      - name: Start local node
        run: npx @hashgraph/hedera-local start -d --network local --network-tag=0.57.0 --balance=100000

      - name: Run Examples
        run: task run-examples

      - name: Stop local node
        run: npx @hashgraph/hedera-local stop
